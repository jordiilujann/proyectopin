<div class="min-h-screen bg-gradient-to-b from-[#451a1a] via-[#1a1a1a] to-black text-white pb-32 font-sans relative overflow-hidden">
  
  <div class="absolute top-[-100px] right-[-100px] w-[500px] h-[500px] bg-red-900/20 rounded-full blur-[120px] pointer-events-none z-0"></div>
  <div class="absolute top-[10%] left-[-100px] w-[300px] h-[300px] bg-red-600/10 rounded-full blur-[100px] pointer-events-none z-0"></div>

  <div class="max-w-md mx-auto px-4 pt-12 relative z-10">
    
    <h1 class="text-3xl font-bold mb-6 tracking-tight text-white drop-shadow-md">Para ti</h1>

    <div class="space-y-4"> @for (review of reviews; track review._id) {
        
        <div class="flex flex-col animate-fadeIn">
          
          <div class="flex items-center gap-3 mb-2 px-1">
            <div class="w-9 h-9 rounded-full bg-zinc-800 overflow-hidden border border-white/10 shadow-md">
                <img 
                *ngIf="review.user_name" 
                [src]="'https://ui-avatars.com/api/?name=' + review.user_name + '&background=random'" 
                alt="Avatar"
                class="w-full h-full object-cover"
                >
            </div>
            <div class="leading-tight">
              <h3 class="font-bold text-sm text-zinc-100 shadow-black drop-shadow-sm">{{ review.user_name || 'Usuario' }}</h3>
              <p class="text-[10px] text-zinc-400">@{{ (review.user_name || 'usuario').replace(' ', '').toLowerCase() }}</p>
            </div>
          </div>

          <div 
            class="bg-[#1C1C1C]/90 backdrop-blur-sm p-3 flex gap-4 relative overflow-hidden group border border-white/5 hover:border-white/10 transition-all items-start shadow-xl"
            [ngClass]="selectedItemId === review.spotify_id ? 'rounded-t-2xl' : 'rounded-2xl'"
          >
            
            <div class="shrink-0 relative">
              <img 
                [src]="review.item_cover_url" 
                class="w-20 h-20 rounded-lg object-cover shadow-lg ring-1 ring-black/50"
                alt="Cover"
                onerror="this.src='assets/placeholder.png'" 
              >
              <div class="absolute top-1 right-1 bg-black/60 rounded-full p-1 backdrop-blur-md border border-white/10">
                 <svg *ngIf="review.target_type === 'track'" class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                 <svg *ngIf="review.target_type === 'album'" class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>
              </div>
            </div>

            <div class="flex-1 min-w-0 flex flex-col">
              
              <div class="flex justify-between items-start">
                <h4 
                  class="font-bold text-zinc-100 text-sm truncate pr-2 transition-colors duration-200"
                  [ngClass]="review.user_id !== currentUserId ? 'cursor-pointer hover:text-blue-400' : ''"
                  (click)="goToReviewItem(review)"
                >
                  {{ review.item_name }} <span class="text-zinc-500 font-normal">· {{ review.item_artists?.[0] || 'Artista' }}</span>
                </h4>
              </div>

              <div class="flex items-center justify-between mt-1 mb-1">
                  <div class="flex items-center gap-2">
                    <div class="flex text-zinc-400 text-xs">
                        @for (star of [1,2,3,4,5]; track star) {
                        <svg class="w-3 h-3" [class.text-white]="star <= review.rating" [class.fill-current]="star <= review.rating" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                        }
                    </div>
                    
                    <ng-container *ngIf="getAverageRatingForItem(review.spotify_id) !== '-'">
                        <span class="text-[9px] font-bold text-yellow-500 bg-yellow-500/10 px-1.5 py-0.5 rounded border border-yellow-500/20 whitespace-nowrap">
                            Promedio {{ getAverageRatingForItem(review.spotify_id) }}/5
                        </span>
                    </ng-container>
                  </div>

                  <button 
                    (click)="viewItemReviews(review.spotify_id || '', review.target_type)"
                    class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 transition-colors">
                    <span class="text-[10px] font-bold text-blue-400">
                        {{ selectedItemId === review.spotify_id ? 'Cerrar' : 'Opiniones' }}
                    </span>
                  </button>
              </div>

              @if (review.target_type === 'track' && review.timestamp_ms && review.timestamp_ms > 0) {
                <div class="mb-2">
                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md bg-zinc-800/80 text-zinc-300 text-[9px] font-medium border border-zinc-700/50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        {{ formatDuration(review.timestamp_ms) }}
                    </span>
                </div>
              }

              <h5 class="text-xs font-bold text-white mb-0.5 mt-1">{{ review.title }}</h5>

              <p class="text-xs text-zinc-300 leading-relaxed whitespace-pre-wrap break-words">
                {{ review.content }}
              </p>
            </div>
          </div>

          @if (selectedItemId === review.spotify_id) {
            <div class="bg-[#151515]/95 border-x border-b border-white/5 rounded-b-2xl p-4 animate-fadeIn mb-1 shadow-inner">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-zinc-500 uppercase tracking-wide">Comunidad</span>
                    @if (!isLoadingReviews && selectedItemReviews.length > 1 && !hasUserReviewed(selectedItemReviews)) {
                        <button (click)="goToCreateReview(review)" class="text-[10px] bg-white text-black px-2 py-1 rounded font-bold hover:bg-zinc-200 transition-colors">
                            + Añadir la tuya
                        </button>
                    }
                </div>

                @if (isLoadingReviews) {
                    <div class="flex justify-center py-2"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div></div>
                } @else {
                    <div class="space-y-2">
                        @for (other of selectedItemReviews; track other._id) {
                            @if (other._id !== review._id) {
                                <div class="bg-black/50 p-2 rounded border border-white/5 flex gap-2 items-start">
                                    <div class="font-bold text-zinc-400 text-xs min-w-[60px]">{{ other.user_name }}</div>
                                    <div class="flex-1 text-zinc-300 text-xs whitespace-pre-wrap break-words">{{ other.content }}</div>
                                    <div class="text-yellow-500 text-[10px]">★{{ other.rating }}</div>
                                </div>
                            }
                        }
                        @if (selectedItemReviews.length <= 1) {
                            <p class="text-center text-xs text-zinc-600">Nadie más ha opinado sobre esto.</p>
                        }
                    </div>
                }
            </div>
          }

          <div class="flex justify-end items-center gap-4 mt-1 px-2 relative mb-4">
            
            <button class="text-zinc-500 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
            </button>
            
            @if (currentUserId === review.user_id) {
                <div class="relative">
                    <button (click)="toggleMenu($event, review._id!)" class="text-zinc-500 hover:text-white transition-colors rotate-90">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
                        </svg>
                    </button>

                    @if (activeMenuId === review._id) {
                        <div class="absolute bottom-full right-0 mb-2 w-32 bg-[#252525] border border-zinc-700 rounded-xl shadow-xl z-50 overflow-hidden animate-fadeIn">
                            <button 
                                [routerLink]="['/app/review', {id: review._id}]" 
                                class="w-full text-left px-4 py-3 text-xs text-white hover:bg-white/10 transition-colors flex items-center gap-2">
                                <span>✏️</span> Editar
                            </button>
                        </div>
                    }
                </div>
            }
          </div>

        </div>
      }

      @if (reviews.length === 0 && !loading) {
         <div class="text-center py-20 text-zinc-600">
           <p>No hay reseñas aún.</p>
         </div>
      }
    </div>
  </div>
</div>