<div 
  class="min-h-screen text-white font-sans pb-32 selection:bg-red-500 selection:text-white transition-all duration-700 ease-in-out"
  [style.background]="currentGradient">
  
  <header class="flex justify-between items-center p-6 mb-2">
    <button 
      class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-all backdrop-blur-sm" 
      [routerLink]="['/app/feed']">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-zinc-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </button>
    <h1 class="text-lg font-semibold tracking-wide text-zinc-100">
      {{ isEditMode ? 'Editar Reseña' : 'Nueva Reseña' }}
    </h1>
    <div class="w-10"></div>
  </header>

  <div class="max-w-md mx-auto px-6">
    
    <section class="mb-6 animate-fadeIn" *ngIf="!selectedItem && !isEditMode">
      <div class="relative">
        <input 
          type="text"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchInput()"
          (keyup.enter)="search()"
          class="w-full p-4 pl-12 bg-[#242424] text-zinc-100 rounded-2xl border-none focus:ring-1 focus:ring-zinc-500 placeholder-zinc-500 shadow-lg"
          placeholder="Busca canción, álbum o artista..." 
        />
        <svg class="absolute left-4 top-4 h-6 w-6 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        
        <button 
          *ngIf="searchQuery"
          (click)="search()"
          class="absolute right-2 top-2 bottom-2 px-4 bg-zinc-700 hover:bg-zinc-600 rounded-xl text-sm font-medium transition-colors"
          [disabled]="isLoading">
          Buscar
        </button>
      </div>
      
      <div *ngIf="error" class="mt-4 p-3 bg-red-500/20 border border-red-500/50 text-red-200 rounded-xl text-sm text-center">
        {{ error }}
      </div>
    </section>

    <div *ngIf="!selectedItem && (searchResults.tracks.length > 0 || searchResults.albums.length > 0 || searchResults.artists.length > 0)" class="mb-6 space-y-3 animate-fadeIn">
      <div *ngFor="let track of searchResults.tracks" 
           (click)="selectItem(track, 'track')"
           class="flex items-center p-3 bg-[#1e1e1e] hover:bg-[#2a2a2a] rounded-xl cursor-pointer transition-all border border-transparent hover:border-zinc-700">
        <img [src]="track.coverUrl" class="w-12 h-12 rounded-lg shadow-md mr-4 object-cover" alt="Cover"/>
        <div class="flex-1 min-w-0">
          <h4 class="font-semibold text-zinc-100 text-sm leading-tight">{{ track.name }}</h4>
          <p class="text-xs text-zinc-400 mt-1">{{ getArtistNames(track.artists) }}</p>
        </div>
        <div class="text-zinc-500 ml-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
      </div>
      
      <div *ngFor="let album of searchResults.albums" 
           (click)="selectItem(album, 'album')"
           class="flex items-center p-3 bg-[#1e1e1e] hover:bg-[#2a2a2a] rounded-xl cursor-pointer transition-all border border-transparent hover:border-zinc-700">
        <img [src]="album.coverUrl" class="w-12 h-12 rounded-lg shadow-md mr-4 object-cover" alt="Cover"/>
        <div class="flex-1 min-w-0">
          <h4 class="font-semibold text-zinc-100 text-sm leading-tight">{{ album.name }}</h4>
          <p class="text-xs text-zinc-400 mt-1">{{ getArtistNames(album.artists) }}</p>
        </div>
        <div class="text-zinc-500 ml-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg>
        </div>
      </div>
      
      <div *ngFor="let artist of searchResults.artists" 
           (click)="selectItem(artist, 'artist')"
           class="flex items-center p-3 bg-[#1e1e1e] hover:bg-[#2a2a2a] rounded-xl cursor-pointer transition-all border border-transparent hover:border-zinc-700">
        <img *ngIf="artist.images && artist.images.length > 0" [src]="artist.images[0].url" class="w-12 h-12 rounded-lg shadow-md mr-4 object-cover" alt="Artist"/>
        <div *ngIf="!artist.images || artist.images.length === 0" class="w-12 h-12 rounded-lg shadow-md mr-4 bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg">
          {{ artist.name.charAt(0) }}
        </div>
        <div class="flex-1 min-w-0">
          <h4 class="font-semibold text-zinc-100 text-sm leading-tight">{{ artist.name }}</h4>
          <p *ngIf="artist.genres && artist.genres.length > 0" class="text-xs text-zinc-400 mt-1">{{ artist.genres[0] }}</p>
        </div>
        <div class="text-zinc-500 ml-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
      </div>
    </div>

    <div *ngIf="selectedItem" class="animate-fadeIn">
      
      <div class="bg-[#1e1e1e] rounded-2xl p-4 flex items-center mb-6 shadow-xl border border-white/5 relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-red-900/20 rounded-full blur-3xl pointer-events-none"></div>
        
        <img 
          [src]="selectedItem.coverUrl" 
          class="w-16 h-16 rounded-lg shadow-lg mr-4 object-cover z-10"
          alt="Portada"
        />
        <div class="flex-1 z-10 min-w-0">
          <h3 class="font-bold text-white text-lg truncate">{{ selectedItem.name }}</h3>
          <p class="text-sm text-zinc-400 truncate">
            {{ selectedItem.artists ? getArtistNames(selectedItem.artists) : selectedItem.type }}
            <span *ngIf="selectedItem.genre">• {{ selectedItem.genre }}</span>
          </p>
          <p *ngIf="selectedItem.year" class="text-xs text-zinc-500 mt-0.5">{{ selectedItem.year }}</p>
        </div>
        
        <button *ngIf="!isEditMode" (click)="selectedItem = null" class="absolute top-2 right-2 p-2 text-zinc-500 hover:text-white z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
      </div>

      <div class="bg-[#242424] rounded-3xl p-6 shadow-2xl mb-8 relative border border-white/5">
        
        <p class="text-zinc-400 text-sm mb-3 font-medium ml-1">Pon tus estrellas</p>

        <div 
          #starContainer
          class="flex space-x-2 mb-6 cursor-pointer select-none justify-center touch-none"
          (mousedown)="onStarStart($event)"
          (mousemove)="onStarMove($event)"
          (mouseup)="onStarEnd()"
          (mouseleave)="onStarEnd()"
          (touchstart)="onStarStart($event)"
          (touchmove)="onStarMove($event)"
          (touchend)="onStarEnd()">
          
          <div 
            *ngFor="let star of [1,2,3,4,5]"
            class="relative w-10 h-10 transition-transform active:scale-95">
            <svg class="absolute inset-0 w-full h-full pointer-events-none text-zinc-600" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
            <svg *ngIf="rating >= star - 0.5 && rating < star" class="absolute inset-0 w-full h-full pointer-events-none text-white fill-white" viewBox="0 0 24 24" style="clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
            <svg *ngIf="rating >= star" class="absolute inset-0 w-full h-full pointer-events-none text-white fill-white" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
          </div>
        </div>
        
        <p class="text-xs text-zinc-500 ml-1 mb-2 text-center">Rating: {{ rating || 0 }} / 5</p>

        <div class="h-px bg-zinc-700/50 w-full mb-6"></div>

        <p class="text-zinc-500 text-xs mb-1 ml-1">Título (Opcional)</p>
        <input 
          type="text"
          [(ngModel)]="title"
          class="w-full bg-transparent text-zinc-100 text-lg font-bold border-none focus:ring-0 p-0 mb-4 placeholder-zinc-600 focus:outline-none"
          placeholder="Un título corto..."
        />

        <p class="text-zinc-500 text-xs mb-2 ml-1">No te ralles, aquí nadie juzga</p>
        <textarea 
          [(ngModel)]="content"
          class="w-full h-32 bg-transparent text-zinc-300 text-base leading-relaxed border-none focus:ring-0 p-0 resize-none placeholder-zinc-600 focus:outline-none"
          placeholder="Opino que..."></textarea>
      </div>

      <div *ngIf="selectedItem?.type === 'track'" class="mb-8 px-2">
         <div class="flex justify-between text-xs text-zinc-400 mb-2 font-medium">
            <span>Momento clave</span>
            <span>{{ formatTimestamp(timestampMs) }}</span>
         </div>
         <input 
            type="range"
            [(ngModel)]="timestampMs"
            (input)="onTimestampInput($event)"
            [max]="trackDurationMs || 0"
            class="w-full h-1.5 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-white"
         />
      </div>

      <div class="flex flex-col items-center gap-4">
        <button 
          class="bg-white/90 hover:bg-white text-zinc-900 font-bold py-3 px-12 rounded-full shadow-lg shadow-white/5 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:scale-100"
          [disabled]="!selectedItem || rating === 0"
          (click)="submitReview()">
          {{ isEditMode ? 'Guardar Cambios' : 'Publicar' }}
        </button>

        <button 
          *ngIf="isEditMode"
          class="text-red-400 text-sm font-medium hover:text-red-300 py-2 transition-colors"
          (click)="deleteReview()">
          Eliminar esta reseña
        </button>
      </div>

    </div>
  </div>
</div>

@if (showModal) {
<div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fadeIn">
  <div class="bg-[#1e1e1e] border border-zinc-700 rounded-2xl shadow-2xl max-w-xs w-full overflow-hidden transform transition-all scale-100 text-center p-6">
    
    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4"
         [ngClass]="modalType === 'success' ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'">
       <svg *ngIf="modalType === 'success'" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
       <svg *ngIf="modalType !== 'success'" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
    </div>

    <h3 class="text-lg font-bold text-white mb-2">{{ modalTitle }}</h3>
    <p class="text-sm text-zinc-400 mb-6">{{ modalMessage }}</p>

    <div class="flex gap-3 justify-center">
      <button 
        *ngIf="modalType === 'confirm'"
        class="flex-1 py-2 px-4 rounded-lg bg-zinc-800 text-zinc-300 font-medium hover:bg-zinc-700 transition-colors"
        (click)="closeModal()">
        Cancelar
      </button>
      <button 
        class="flex-1 py-2 px-4 rounded-lg font-medium text-white transition-colors"
        [ngClass]="modalType === 'success' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'"
        (click)="onModalConfirm()">
        {{ modalType === 'success' ? 'Genial' : 'Eliminar' }}
      </button>
    </div>
  </div>
</div>
}